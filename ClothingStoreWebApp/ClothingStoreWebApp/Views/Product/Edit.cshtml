@model ClothingStoreWebApp.Models.Product
@{
    ViewBag.Title = "Chỉnh sửa - " + Model.ProductName;
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-edit text-warning"></i>
            Chỉnh sửa sản phẩm
        </h2>
        <div>
            @Html.ActionLink("Xem chi tiết", "Details", new { id = Model.ProductID }, new { @class = "btn btn-info" })
            @Html.ActionLink("Quay lại", "Index", "Admin", null, new { @class = "btn btn-secondary" })
        </div>
    </div>

    @using (Html.BeginForm("Edit", "Product", FormMethod.Post, new { @class = "row", enctype = "multipart/form-data" }))
    {
        @Html.AntiForgeryToken()
        @Html.HiddenFor(model => model.ProductID)
        @Html.HiddenFor(model => model.CreatedAt)
        @Html.HiddenFor(model => model.UpdatedAt)

        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i> Thông tin cơ bản
                    </h6>
                </div>
                <div class="card-body">
                    @Html.ValidationSummary(true, "", new { @class = "alert alert-danger" })

                    <div class="mb-3">
                        @Html.LabelFor(model => model.ProductName, new { @class = "form-label" })
                        @Html.TextBoxFor(model => model.ProductName, new { @class = "form-control" })
                        @Html.ValidationMessageFor(model => model.ProductName, "", new { @class = "text-danger" })
                    </div>

                    <div class="mb-3">
                        @Html.LabelFor(model => model.Description, new { @class = "form-label" })
                        @Html.TextAreaFor(model => model.Description, new { @class = "form-control", rows = 4 })
                        @Html.ValidationMessageFor(model => model.Description, "", new { @class = "text-danger" })
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            @Html.LabelFor(model => model.CategoryID, "Danh mục", new { @class = "form-label" })
                            <select name="CategoryID" class="form-select">
                                <option value="">-- Chọn danh mục --</option>
                                @foreach (var item in (SelectList)ViewBag.CategoryID)
                                {
                                    <option value="@item.Value" @(item.Selected ? "selected" : "")>@item.Text</option>
                                }
                            </select>
                            @Html.ValidationMessageFor(model => model.CategoryID, "", new { @class = "text-danger" })
                        </div>

                        <div class="col-md-6 mb-3">
                            @Html.LabelFor(model => model.BrandID, "Thương hiệu", new { @class = "form-label" })
                            <select name="BrandID" class="form-select">
                                <option value="">-- Chọn thương hiệu --</option>
                                @foreach (var item in (SelectList)ViewBag.BrandID)
                                {
                                    <option value="@item.Value" @(item.Selected ? "selected" : "")>@item.Text</option>
                                }
                            </select>
                            @Html.ValidationMessageFor(model => model.BrandID, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            @Html.LabelFor(model => model.CollectionID, "Bộ sưu tập", new { @class = "form-label" })
                            <select name="CollectionID" class="form-select">
                                <option value="">-- Chọn bộ sưu tập (tùy chọn) --</option>
                                @foreach (var item in (SelectList)ViewBag.CollectionID)
                                {
                                    <option value="@item.Value" @(item.Selected ? "selected" : "")>@item.Text</option>
                                }
                            </select>
                            @Html.ValidationMessageFor(model => model.CollectionID, "", new { @class = "text-danger" })
                        </div>
                        <div class="col-md-6 mb-3">
                            @Html.LabelFor(model => model.Gender, "Giới tính", new { @class = "form-label" })
                            @Html.DropDownListFor(model => model.Gender, new SelectList(new[] { "Nam", "Nữ", "Unisex" }, Model.Gender), "-- Chọn giới tính --", new { @class = "form-select" })
                            @Html.ValidationMessageFor(model => model.Gender, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="mb-3">
                        @Html.LabelFor(model => model.Material, "Chất liệu", new { @class = "form-label" })
                        @Html.TextBoxFor(model => model.Material, new { @class = "form-control" })
                        @Html.ValidationMessageFor(model => model.Material, "", new { @class = "text-danger" })
                    </div>

                    <div class="mb-3">
                        @Html.LabelFor(model => model.CareInstructions, "Hướng dẫn bảo quản", new { @class = "form-label" })
                        @Html.TextAreaFor(model => model.CareInstructions, new { @class = "form-control", rows = 2 })
                        @Html.ValidationMessageFor(model => model.CareInstructions, "", new { @class = "text-danger" })
                    </div>
                </div>
            </div>

            @* ✅ CURRENT IMAGES - FIXED STRUCTURE *@
            @if (Model.ProductImages != null && Model.ProductImages.Any())
            {
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-images"></i> <strong>Hình ảnh hiện tại</strong>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle"></i>
                            <strong>Hướng dẫn:</strong> Click nút <span class="badge bg-warning text-dark"><i class="fas fa-star"></i></span> để đặt làm ảnh chính, click nút <i class="fas fa-trash"></i> để xóa.
                        </div>

                        <div class="row g-3">
                            @foreach (var img in Model.ProductImages.OrderBy(pi => pi.SortOrder))
                            {
                                bool isMainImage = img.SortOrder == 0;
                                <div class="col-md-3">
                                    <div class="card image-card-existing @(isMainImage ? "border-warning border-4" : "border-secondary")"
                                         data-image-id="@img.ImageID">

                                        <!-- Image Container -->
                                        <div class="image-container">
                                            <img src="@img.ImageURL"
                                                 class="card-img-top"
                                                 alt="Product image">

                                            <!-- Action Buttons -->
                                            <div class="image-actions">
                                                <button type="button"
                                                        class="btn btn-sm set-main-image-btn @(isMainImage ? "btn-warning" : "btn-outline-warning")"
                                                        data-image-id="@img.ImageID"
                                                        data-product-id="@Model.ProductID"
                                                        onclick="setMainImage(event, this)"
                                                        title="Đặt làm ảnh chính">
                                                    <i class="fas fa-star"></i>
                                                </button>
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-danger"
                                                        data-image-id="@img.ImageID"
                                                        data-product-id="@Model.ProductID"
                                                        onclick="deleteImage(event, this)"
                                                        title="Xóa ảnh">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Card Body Info -->
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">@img.ImageType</small>
                                                @if (isMainImage)
                                                {
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="fas fa-check"></i> Chính
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }


            @* Size và Color Management *@
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-palette"></i> Quản lý Size và Màu sắc
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Size có sẵn:</strong></label>
                            <div class="size-selection">
                                @if (ViewBag.AllSizes != null)
                                {
                                    foreach (var size in ViewBag.AllSizes as List<ClothingStoreWebApp.Models.Size>)
                                    {
                                        bool isSelected = ViewBag.SelectedSizes != null && ((int[])ViewBag.SelectedSizes).Contains(size.SizeID);
                                        <div class="form-check form-check-inline">
                                            <input type="checkbox" name="SelectedSizes" value="@size.SizeID"
                                                   class="form-check-input size-checkbox" id="size_@size.SizeID" @(isSelected ? "checked" : "")>
                                            <label class="form-check-label size-label" for="size_@size.SizeID">
                                                <span class="size-badge @(isSelected ? "selected" : "")">@size.SizeName</span>
                                            </label>
                                        </div>
                                    }
                                }
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label"><strong>Màu sắc có sẵn:</strong></label>
                            <div class="color-selection row">
                                @if (ViewBag.AllColors != null)
                                {
                                    foreach (var color in ViewBag.AllColors as List<ClothingStoreWebApp.Models.Color>)
                                    {
                                        bool isSelected = ViewBag.SelectedColors != null && ((int[])ViewBag.SelectedColors).Contains(color.ColorID);
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check color-item">
                                                <input type="checkbox" name="SelectedColors" value="@color.ColorID"
                                                       class="form-check-input" id="color_@color.ColorID" @(isSelected ? "checked" : "")>
                                                <label class="form-check-label d-flex align-items-center" for="color_@color.ColorID">
                                                    <span class="color-preview me-2" style="background-color: @color.ColorCode;"></span>
                                                    <span class="color-name">@color.ColorName</span>
                                                </label>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Lưu ý:</strong> Chọn Size và Color để tự động tạo các ProductVariant.
                    </div>
                </div>
            </div>

            @* ✅ SỬA: UPLOAD NEW IMAGES *@
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-upload"></i> <strong>Thêm hình ảnh mới</strong>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Chọn ảnh mới (tùy chọn)</label>
                        <input type="file" name="productImages" multiple accept="image/*" class="form-control" id="productImages">
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i>
                            Chọn ảnh mới để bổ sung. Để trống nếu không muốn thêm ảnh.
                        </div>
                    </div>

                    <div id="imagePreview" class="row g-3"></div>
                </div>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cog"></i> Cài đặt
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        @Html.LabelFor(model => model.BasePrice, "Giá cơ bản (VND)", new { @class = "form-label" })
                        <input type="number"
                               name="BasePrice"
                               class="form-control"
                               value="@Model.BasePrice.ToString("0")"
                               step="1000"
                               min="0"
                               placeholder="0" />
                        @Html.ValidationMessageFor(model => model.BasePrice, "", new { @class = "text-danger" })
                    </div>

                    <div class="mb-3 form-check">
                        @Html.CheckBoxFor(model => model.IsActive, new { @class = "form-check-input" })
                        @Html.LabelFor(model => model.IsActive, "Kích hoạt sản phẩm", new { @class = "form-check-label" })
                    </div>

                    <div class="mb-3 form-check">
                        @Html.CheckBoxFor(model => model.IsFeatured, new { @class = "form-check-input" })
                        @Html.LabelFor(model => model.IsFeatured, "Sản phẩm nổi bật", new { @class = "form-check-label" })
                    </div>

                    <hr>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save"></i> Lưu thay đổi
                        </button>
                        @Html.ActionLink("Hủy", "Index", "Admin", null, new { @class = "btn btn-secondary" })
                    </div>

                    <hr>

                    <div class="text-muted small">
                        <p><strong>ID:</strong> @Model.ProductID</p>
                        <p><strong>Tạo:</strong> @Model.CreatedAt.ToString("dd/MM/yyyy")</p>
                        <p><strong>Cập nhật:</strong> @Model.UpdatedAt.ToString("dd/MM/yyyy")</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    /* ✅ IMAGE CARD - CLEAN STRUCTURE */
    .image-card-existing {
        transition: all 0.3s ease;
        cursor: pointer;
        height: 100%;
        border: 2px solid;
        overflow: hidden;
    }

        .image-card-existing:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

            .image-card-existing:hover .image-actions {
                display: flex !important;
            }

        .image-card-existing.border-warning {
            background-color: #fffbf0;
        }

        .image-card-existing.border-secondary {
            background-color: #fff;
        }

    /* ✅ IMAGE CONTAINER */
    .image-container {
        position: relative;
        width: 100%;
        height: 200px;
        background: #f8f9fa;
        overflow: hidden;
    }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    /* ✅ ACTION BUTTONS */
    .image-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.6) 100%);
        padding: 8px;
        border-radius: 8px;
        display: none !important;
        gap: 6px;
        flex-direction: row;
        z-index: 100;
    }

        .image-actions .btn {
            padding: 6px 8px;
            font-size: 13px;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
        }

        .image-actions .btn-sm {
            width: 38px;
            height: 38px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            padding: 0 !important;
        }

        /* BUTTON STYLES */
        .image-actions .btn-outline-warning {
            background-color: rgba(255, 193, 7, 0.3);
            border-color: #ffc107 !important;
            color: #ffc107 !important;
        }

            .image-actions .btn-outline-warning:hover {
                background-color: #ffc107 !important;
                border-color: #ffc107 !important;
                color: #000 !important;
                transform: scale(1.15);
                box-shadow: 0 4px 10px rgba(255, 193, 7, 0.5);
            }

        .image-actions .btn-outline-danger {
            background-color: rgba(220, 53, 69, 0.3);
            border-color: #dc3545 !important;
            color: #dc3545 !important;
        }

            .image-actions .btn-outline-danger:hover {
                background-color: #dc3545 !important;
                border-color: #dc3545 !important;
                color: #fff !important;
                transform: scale(1.15);
                box-shadow: 0 4px 10px rgba(220, 53, 69, 0.5);
            }

        .image-actions .btn-warning {
            background-color: #ffc107 !important;
            border-color: #ffc107 !important;
            color: #000 !important;
            box-shadow: 0 2px 6px rgba(255, 193, 7, 0.4);
        }

            .image-actions .btn-warning:hover {
                transform: scale(1.15);
                box-shadow: 0 4px 10px rgba(255, 193, 7, 0.6);
            }

    /* ============ NEW IMAGE PREVIEW ============ */
    #imagePreview .card {
        border: 2px dashed #28a745;
        background-color: #f0fff4;
    }

    #imagePreview .card-img-top {
        height: 150px;
        object-fit: cover;
    }

    /* ============ SIZE SELECTION ============ */
    .size-selection {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .size-checkbox {
        display: none;
    }

    .size-label {
        cursor: pointer;
        margin: 0;
    }

    .size-badge {
        display: inline-block;
        padding: 8px 16px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        background-color: #fff;
        color: #495057;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        cursor: pointer;
        min-width: 50px;
        text-align: center;
    }

        .size-badge:hover {
            border-color: #0d6efd;
            background-color: #e7f1ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
        }

        .size-checkbox:checked + .size-label .size-badge,
        .size-badge.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: #fff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

    /* ============ COLOR SELECTION ============ */
    .color-selection {
        max-height: 300px;
        overflow-y: auto;
    }

    .color-item {
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .color-item:hover {
            background-color: #f8f9fa;
            transform: translateX(3px);
        }

    .form-check-input:checked ~ .form-check-label {
        font-weight: 600;
        color: #0d6efd;
    }

    .color-preview {
        width: 28px;
        height: 28px;
        border: 2px solid #dee2e6;
        border-radius: 6px;
        display: inline-block;
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .color-item:hover .color-preview {
        transform: scale(1.15);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .form-check-input:checked ~ .form-check-label .color-preview {
        border-color: #0d6efd;
        border-width: 3px;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
    }

    .color-name {
        font-size: 14px;
        transition: color 0.3s ease;
    }

    .color-selection::-webkit-scrollbar {
        width: 6px;
    }

    .color-selection::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .color-selection::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

        .color-selection::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
</style>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    if (!window.editPageInitialized) {
        window.editPageInitialized = true;
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ Page initialized');
        });
    }

    function deleteImage(event, button) {
        event.preventDefault();
        if (!confirm('Xóa ảnh này?')) return;

        const imageId = parseInt(button.getAttribute('data-image-id'));
        const productId = parseInt(button.getAttribute('data-product-id'));
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        console.log('🗑️ DELETE request:', imageId, productId);

        fetch('/Product/DeleteProductImage', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                imageId: imageId,
                productId: productId,
                __RequestVerificationToken: token
            })
        })
            .then(r => {
                console.log('Response status:', r.status);
                return r.json();
            })
            .then(data => {
                console.log('✅ Response:', data);
                if (data.success) {
                    location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(e => {
                console.error('❌ Error:', e);
                alert('Lỗi: ' + e.message);
            });
    }

    function setMainImage(event, button) {
        event.preventDefault();

        const imageId = parseInt(button.getAttribute('data-image-id'));
        const productId = parseInt(button.getAttribute('data-product-id'));
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        console.log('🔄 POST request:', imageId, productId);

        fetch('/Product/SetMainImage', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                imageId: imageId,
                productId: productId,
                __RequestVerificationToken: token
            })
        })
            .then(r => {
                console.log('Response status:', r.status);
                return r.json();
            })
            .then(data => {
                console.log('✅ Response:', data);
                if (data.success) {
                    location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(e => {
                console.error('❌ Error:', e);
                alert('Lỗi: ' + e.message);
            });
    }





    // Size and Color initialization
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.size-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const badge = this.nextElementSibling?.querySelector('.size-badge');
                if (badge) {
                    badge.classList.toggle('selected', this.checked);
                }
            });
        });

        const fileInput = document.getElementById('productImages');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const preview = document.getElementById('imagePreview');
                if (!preview) return;
                preview.innerHTML = '';

                Array.from(this.files).forEach((file, i) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            const col = document.createElement('div');
                            col.className = 'col-md-4 mb-3';
                            col.innerHTML = `
                                <div class="card border-success">
                                    <img src="${evt.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <small class="text-success"><i class="fas fa-check-circle"></i> ${file.name}</small>
                                        ${i === 0 ? '<br><span class="badge bg-success mt-2"><i class="fas fa-star"></i> Ảnh chính</span>' : ''}
                                    </div>
                                </div>
                            `;
                            preview.appendChild(col);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            });
        }
    });
</script>





